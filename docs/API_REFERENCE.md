# Cocoon Rearing Recommender API Reference

Base URL: `http://localhost:8000/api`

## Authentication

### User Registration
Register a new user (Farmer or Admin).

- **Endpoint**: `POST /auth/register`
- **Access**: Public

**Request Body** OAUTHPARAMETERS
```json
{
  "email": "farmer@example.com",
  "password": "securepassword123",
  "role": "Farmer",  // Options: "Farmer", "Admin"
  "name": "John Doe" // Optional
}
```

**Response (201 Created)**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user": {
    "id": "65b262...",
    "email": "farmer@example.com",
    "role": "Farmer",
    "name": "John Doe",
    "created_at": "2026-01-25T10:00:00.000000"
  }
}
```

### User Login
Authenticate with email and password to get a JWT token.

- **Endpoint**: `POST /auth/login`
- **Access**: Public

**Request Body**
```json
{
  "email": "farmer@example.com",
  "password": "securepassword123"
}
```

**Response (200 OK)**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user": {
    "id": "65b262...",
    "email": "farmer@example.com",
    "role": "Farmer",
    "name": "John Doe",
    "created_at": "2026-01-25T10:00:00.000000"
  }
}
```

### Get Current User Profile
Get details of the currently authenticated user.

- **Endpoint**: `GET /auth/me`
- **Access**: Authenticated (Any Role)
- **Headers**: `Authorization: Bearer <access_token>`

**Response (200 OK)**
```json
{
  "id": "65b262...",
  "email": "farmer@example.com",
  "role": "Farmer",
  "name": "John Doe",
  "created_at": "2026-01-25T10:00:00.000000"
}
```

---

## Farmer Profile Management

### Create/Update Profile
Create or update the profile details for a farmer.

- **Endpoint**: `POST /farmer/profile`
- **Access**: Farmer Only
- **Headers**: `Authorization: Bearer <access_token>`

**Request Body**
```json
{
  "district": "Bengaluru",
  "experience_years": 5,      // Optional
  "farm_size_acres": 2.5,     // Optional
  "phone_number": "9876543210" // Optional
}
```

**Response (201 Created)**
```json
{
  "id": "65b263...",
  "user_id": "65b262...",
  "district": "Bengaluru",
  "experience_years": 5,
  "farm_size_acres": 2.5,
  "phone_number": "9876543210",
  "created_at": "...",
  "updated_at": "..."
}
```

### Get Profile
Retrieve the authenticated farmer's profile.

- **Endpoint**: `GET /farmer/profile`
- **Access**: Farmer Only
- **Headers**: `Authorization: Bearer <access_token>`

**Response (200 OK)**
```json
{
  "id": "65b263...",
  "user_id": "65b262...",
  "district": "Bengaluru",
  "experience_years": 5,
  "farm_size_acres": 2.5,
  "phone_number": "9876543210",
  ...
}
```

---

## Recommendations & Predictions

### Generate Prediction
Generate a cocoon market price prediction and rearing schedule recommendation.
Fetches real-time weather data from Open-Meteo API for the calculation.

- **Endpoint**: `POST /recommendation/predict`
- **Access**: Farmer Only
- **Headers**: `Authorization: Bearer <access_token>`

**Request Body**
```json
{
  "city": "Bengaluru" // Options: "Bengaluru", "Ramanagar", "Siddlaghatta"
}
```

**Response (201 Created)**
```json
{
  "recommendation_id": "65b264...",
  "city": "Bengaluru",
  "start_date": "2026-01-26",
  "end_date": "2026-02-23",
  "predicted_price": 521.05,
  "confidence_score": 0.85,
  "weather_conditions": {
    "temperature": 21.3,
    "max_temp": 26.0,
    "humidity": 68.8,
    "rainfall": 0.0
  },
  "created_at": "..."
}
```

### Get 10-Day Prediction Graph
Get price predictions for the next 10 days to help farmers choose the best start date.
Uses real 10-day weather forecast.

- **Endpoint**: `GET /recommendation/10day-graph`
- **Access**: Farmer Only
- **Headers**: `Authorization: Bearer <access_token>`
- **Query Parameters**: `city` (string)

**Example Request**
`GET /recommendation/10day-graph?city=Bengaluru`

**Response (200 OK)**
```json
{
  "predictions": [
    {
      "date": "2026-01-26",
      "predicted_price": 425.48,
      "end_date": "2026-02-23",
      "is_best_date": false
    },
    ...
    {
      "date": "2026-01-31",
      "predicted_price": 521.06,
      "end_date": "2026-02-28",
      "is_best_date": true
    }
  ],
  "best_start_date": "2026-01-31",
  "best_predicted_price": 521.06
}
```

### Get Recommendation History
Retrieve list of past recommendations generated by the user.

- **Endpoint**: `GET /recommendation/history`
- **Access**: Farmer Only
- **Headers**: `Authorization: Bearer <access_token>`
- **Query Parameters**: `limit` (int, default=10)

**Response (200 OK)**
```json
{
  "recommendations": [
    {
      "id": "65b264...",
      "city": "Bengaluru",
      "start_date": "2026-01-26",
      "end_date": "2026-02-23",
      "predicted_price": 521.05,
      "created_at": "..."
    }
  ],
  "total": 1
}
```

---

## Admin Management

### Upload Market/Weather Data
Upload historical market prices and weather data for training or analysis.

- **Endpoint**: `POST /admin/market-weather`
- **Access**: Admin Only
- **Headers**: `Authorization: Bearer <access_token>`

**Request Body**
```json
{
  "city": "Bengaluru",
  "date": "2026-01-25",
  "market_price": 500.0,
  "avg_temp": 24.5,
  "max_temp": 29.0,
  "avg_humidity": 60.0,
  "rainfall": 0.0
}
```

### Get Market/Weather Data
Retrieve uploaded market and weather data records.

- **Endpoint**: `GET /admin/market-weather`
- **Access**: Admin Only
- **Headers**: `Authorization: Bearer <access_token>`
- **Query Parameters**:
  - `city` (Optional)
  - `start_date` (Optional, ISO8601)
  - `end_date` (Optional, ISO8601)
  - `limit` (Optional, default=100)

---

## System Health

### Health Check
Check the status of the API, database, and ML model.

- **Endpoint**: `GET /health`
- **Access**: Public

**Response (200 OK)**
```json
{
  "status": "healthy",
  "timestamp": "...",
  "database": {
    "status": "connected",
    "type": "MongoDB"
  },
  "ml_model": {
    "model_loaded": true,
    "model_type": "XGBRegressor",
    "city_encoder": true,
    "season_encoder": true,
    "status": "healthy"
  },
  "api": {
    "status": "running",
    "version": "1.0.0"
  }
}
```
